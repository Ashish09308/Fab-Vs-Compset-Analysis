<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>FabHotel Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0b0e18;color:#cbd5e1;font-family:system-ui,sans-serif;min-height:100vh}
nav{background:#0f1422;border-bottom:1px solid #1a2035;padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:20}
.logo{width:30px;height:30px;border-radius:7px;background:linear-gradient(135deg,#f97316,#ec4899);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:#fff}
.nav-inner{display:flex;align-items:center;gap:10px}
.nav-title{font-weight:700;font-size:17px;color:#f1f5f9}
.nav-sub{font-size:12px;color:#475569}
.main{padding:24px 28px}
.controls{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.btn{padding:7px 16px;border-radius:8px;border:1px solid;font-size:13px;cursor:pointer;background:#0b0e18;font-weight:400;transition:all .15s}
.btn-clear{padding:7px 14px;border-radius:8px;border:1px solid #f8717155;font-size:12px;cursor:pointer;background:#2d101022;color:#f87171;display:none}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px}
.kpi{border-radius:12px;padding:18px 24px;background:#0f1422}
.kpi-label{font-size:11px;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.kpi-value{font-size:26px;font-weight:700;margin-bottom:8px}
.kpi-foot{display:flex;align-items:center;gap:6px}
.kpi-vs{font-size:11px;color:#334155}
.card{background:#0f1422;border:1px solid #1a2035;border-radius:12px;overflow:hidden}
.toolbar{padding:14px 20px;border-bottom:1px solid #1a2035;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.toolbar input,#citySelect{background:#0b0e18;border:1px solid #1a2035;border-radius:7px;padding:7px 12px;color:#e2e8f0;font-size:13px;outline:none}
#citySelect{padding:7px 10px;color:#94a3b8;cursor:pointer}
.legend{display:flex;gap:20px;padding:10px 20px;border-bottom:1px solid #1a2035;align-items:center;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:#64748b}
.legend-dot{width:10px;height:10px;border-radius:2px}
.legend-hint{margin-left:auto;font-size:11px;color:#475569}
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{padding:10px 10px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;background:#0f1422;position:relative;user-select:none}
td{padding:11px 12px;color:#94a3b8;white-space:nowrap;font-size:12px}
tr{border-bottom:1px solid #111827}
tr:hover td{background:#151b2e!important}
.th-inner{display:flex;align-items:center;gap:3px}
.th-arrow{cursor:pointer;font-size:11px;padding:1px 4px;border-radius:4px;color:#334155;border:1px solid transparent}
.th-arrow.active{color:#60a5fa;background:#1a2035;border-color:#3b82f655}
.th-arrow.filtered{color:#60a5fa;background:#1a2840;border-color:#3b82f655}
.dropdown{position:absolute;top:100%;left:0;z-index:100;background:#161d30;border:1px solid #1e2840;border-radius:10px;width:210px;box-shadow:0 10px 30px rgba(0,0,0,.6);display:none}
.dropdown.open{display:block}
.dd-sort-row{padding:8px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:#94a3b8}
.dd-sort-row:hover,.dd-sort-row.active{background:#1e2640;color:#60a5fa}
.dd-divider{border-bottom:1px solid #1e2840}
.dd-search{padding:8px 10px;border-bottom:1px solid #1e2840}
.dd-search input{width:100%;background:#0b0e18;border:1px solid #1e2840;border-radius:6px;padding:5px 8px;color:#e2e8f0;font-size:11px;outline:none}
.dd-actions{display:flex;gap:6px;padding:6px 10px;border-bottom:1px solid #1e2840;font-size:10px}
.dd-actions span{cursor:pointer}
.dd-actions .sel-all{color:#60a5fa}.dd-actions .clr{color:#f87171}
.dd-sep{color:#334155}
.dd-list{max-height:180px;overflow-y:auto}
.dd-item{display:flex;align-items:center;gap:8px;padding:6px 12px;cursor:pointer;font-size:11px;color:#94a3b8}
.dd-item:hover{background:#1e2640;color:#e2e8f0}
.dd-item input{accent-color:#3b82f6;width:13px;height:13px}
.dd-empty{padding:10px 12px;font-size:11px;color:#475569}
.badge{display:inline-flex;align-items:center;gap:2px;padding:2px 7px;border-radius:20px;font-size:11px;font-weight:700}
.badge-up{background:#0d2e1e;color:#34d399;border:1px solid #065f46}
.badge-dn{background:#2d1010;color:#f87171;border:1px solid #7f1d1d}
.badge-na{color:#475569}
.tbl-foot{padding:12px 20px;border-top:1px solid #1a2035;font-size:12px;color:#334155;display:flex;justify-content:space-between}
.grp-rev{border-left:2px solid rgba(52,211,153,.33)}
.grp-vis{border-left:2px solid rgba(167,139,250,.33)}
.grp-conv{border-left:2px solid rgba(251,191,36,.33)}
.col-rev{color:#34d399}
.col-vis{color:#a78bfa}
.col-conv{color:#fbbf24}
.col-id{color:#60a5fa}
.col-name{color:#e2e8f0}
.col-city-city{color:#38bdf8;font-weight:600}
</style>
</head>
<body>
<nav>
  <div class="nav-inner">
    <div class="logo">F</div>
    <span class="nav-title">FabHotel Dashboard</span>
  </div>
  <span class="nav-sub">Feb 2026 · 30 Properties</span>
</nav>

<div class="main">
  <div class="controls">
    <button class="btn" id="btnProp" onclick="setView('property')">Property View</button>
    <button class="btn" id="btnCity" onclick="setView('city')">City Level</button>
    <button class="btn-clear" id="btnClear" onclick="clearAllFilters()">✕ Clear filters</button>
  </div>

  <div class="kpis" id="kpiContainer"></div>

  <div class="card">
    <div class="toolbar" id="toolbar">
      <input type="text" id="searchBox" placeholder="Search hotel, city, ID..." oninput="renderTable()" style="flex:1;min-width:180px"/>
      <select id="citySelect" onchange="renderTable()">
        <option value="All">All Cities</option>
      </select>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div>Revenue</div>
      <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>Visits</div>
      <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>Conversion</div>
      <span class="legend-hint">Click ▼ on any column to sort or filter</span>
    </div>
    <div class="tbl-wrap"><table id="mainTable"><thead id="thead"></thead><tbody id="tbody"></tbody></table></div>
    <div class="tbl-foot"><span id="footLeft"></span><span id="footRight" style="color:#60a5fa"></span></div>
  </div>
</div>

<script>
const RAW=[
  {id:9827,name:"FabHotel Spiro Grand - Nr. Banashankari",city:"Bangalore",compRns:53.8,fhFebVisits:161,compFebVisits:990.2,fhJanVisits:1158,compJanVisits:471.8,fhJanRev:1.61,compJanRev:1.76,fhFebRev:2.25,compFebRev:2.30,fhJanConv:3.2,compJanConv:1.4,fhFebConv:4.35,compFebConv:2.91},
  {id:8637,name:"FabHotel Carnival - Nr. Irony Market, Newtown",city:"Kolkata",compRns:3.6,fhFebVisits:167,compFebVisits:149,fhJanVisits:11,compJanVisits:4.83,fhJanRev:1.99,compJanRev:0.51,fhFebRev:0.67,compFebRev:0.19,fhJanConv:0,compJanConv:3.45,fhFebConv:1.2,compFebConv:1.61},
  {id:8456,name:"FabHotel Amaltas",city:"Ranchi",compRns:7.17,fhFebVisits:251,compFebVisits:147.33,fhJanVisits:1086,compJanVisits:505.83,fhJanRev:1.28,compJanRev:0.03,fhFebRev:1.01,compFebRev:0.24,fhJanConv:3.5,compJanConv:1.61,fhFebConv:4.78,compFebConv:2.38},
  {id:7848,name:"FabHotel Eros 211 - Nr. Sreebhumi",city:"Kolkata",compRns:11.83,fhFebVisits:445,compFebVisits:258.5,fhJanVisits:1476,compJanVisits:2553.2,fhJanRev:5.84,compJanRev:0.15,fhFebRev:3.15,compFebRev:0.33,fhJanConv:2.71,compJanConv:0.86,fhFebConv:2.92,compFebConv:2.9},
  {id:7594,name:"FabHotel La Paz Stay B&B",city:"New Delhi",compRns:24.6,fhFebVisits:361,compFebVisits:1448,fhJanVisits:371,compJanVisits:692.6,fhJanRev:6.72,compJanRev:1.05,fhFebRev:6.22,compFebRev:1.40,fhJanConv:1.08,compJanConv:4.01,fhFebConv:3.6,compFebConv:0.99},
  {id:7088,name:"Via Ganpati 2",city:"Siliguri",compRns:24.6,fhFebVisits:96,compFebVisits:351.2,fhJanVisits:534,compJanVisits:1047.2,fhJanRev:0.06,compJanRev:0.88,fhFebRev:0,compFebRev:0.94,fhJanConv:0.75,compJanConv:0.4,fhFebConv:0,compFebConv:4.73},
  {id:7056,name:"FabHotel Prime Empire",city:"Amritsar",compRns:1.6,fhFebVisits:232,compFebVisits:521.4,fhJanVisits:null,compJanVisits:null,fhJanRev:1.11,compJanRev:0.09,fhFebRev:0.33,compFebRev:0.06,fhJanConv:0,compJanConv:0,fhFebConv:3.02,compFebConv:0.23},
  {id:6939,name:"Via Shreyas Inn",city:"Bangalore",compRns:61,fhFebVisits:269,compFebVisits:795.4,fhJanVisits:2966,compJanVisits:1977.2,fhJanRev:2.2,compJanRev:2.42,fhFebRev:2.65,compFebRev:2.38,fhJanConv:4.62,compJanConv:2.61,fhFebConv:4.09,compFebConv:3.09},
  {id:6792,name:"FabHotel Nestlay Rooms Airport",city:"Chennai",compRns:43,fhFebVisits:941,compFebVisits:964.8,fhJanVisits:563,compJanVisits:4109.6,fhJanRev:9.95,compJanRev:1.69,fhFebRev:9.64,compFebRev:2.10,fhJanConv:1.42,compJanConv:0.24,fhFebConv:4.78,compFebConv:3.23},
  {id:6726,name:"FabHotel Exotica",city:"New Delhi",compRns:2.4,fhFebVisits:310,compFebVisits:1925.4,fhJanVisits:1364,compJanVisits:4448.4,fhJanRev:1.36,compJanRev:0.44,fhFebRev:2.59,compFebRev:0.16,fhJanConv:0.73,compJanConv:1.28,fhFebConv:2.58,compFebConv:0.08},
  {id:6641,name:"FabHotel Sholas Residency I",city:"Ooty",compRns:37,fhFebVisits:302,compFebVisits:1987.6,fhJanVisits:44,compJanVisits:42.6,fhJanRev:3.04,compJanRev:2.52,fhFebRev:1.06,compFebRev:1.38,fhJanConv:0,compJanConv:0.4,fhFebConv:0.66,compFebConv:1.04},
  {id:6205,name:"FabHotel Lemon Grass - Nr. Assi Ghat",city:"Varanasi",compRns:13.8,fhFebVisits:1063,compFebVisits:669.6,fhJanVisits:652,compJanVisits:421.4,fhJanRev:2.6,compJanRev:0.51,fhFebRev:2.37,compFebRev:0.55,fhJanConv:0.31,compJanConv:1.04,fhFebConv:2.07,compFebConv:1.55},
  {id:6161,name:"FabHotel Vagator Retreat Resort",city:"Goa",compRns:7.6,fhFebVisits:301,compFebVisits:208,fhJanVisits:864,compJanVisits:1015,fhJanRev:0.85,compJanRev:0.22,fhFebRev:2.01,compFebRev:0.29,fhJanConv:4.28,compJanConv:3.9,fhFebConv:1.33,compFebConv:1.54},
  {id:5907,name:"FabHotel Imperio - Nr. Baner Hill",city:"Pune",compRns:31.4,fhFebVisits:340,compFebVisits:435.6,fhJanVisits:720,compJanVisits:2131.6,fhJanRev:4.48,compJanRev:1.18,fhFebRev:4.78,compFebRev:1.13,fhJanConv:2.36,compJanConv:2.7,fhFebConv:3.53,compFebConv:3.81},
  {id:5759,name:"Via Sri Krishna Suites",city:"Bangalore",compRns:109.4,fhFebVisits:249,compFebVisits:930.4,fhJanVisits:1784,compJanVisits:670,fhJanRev:1.93,compJanRev:4.58,fhFebRev:1.19,compFebRev:5.11,fhJanConv:0.39,compJanConv:1.34,fhFebConv:2.01,compFebConv:3.25},
  {id:5169,name:"FabHotel Wild Orchid",city:"Kolkata",compRns:5,fhFebVisits:1282,compFebVisits:273.4,fhJanVisits:146,compJanVisits:17.6,fhJanRev:0.59,compJanRev:0.19,fhFebRev:0.39,compFebRev:0.16,fhJanConv:0.68,compJanConv:0,fhFebConv:0.23,compFebConv:1.32},
  {id:4641,name:"FabHotel P.A.S Residency",city:"Chennai",compRns:2.4,fhFebVisits:2058,compFebVisits:451.4,fhJanVisits:625,compJanVisits:1446.17,fhJanRev:6.78,compJanRev:0.00,fhFebRev:6.31,compFebRev:0.11,fhJanConv:2.08,compJanConv:2.16,fhFebConv:0.44,compFebConv:0.35},
  {id:4468,name:"Oriva Suvee Boutique",city:"Bangalore",compRns:24.33,fhFebVisits:221,compFebVisits:770.5,fhJanVisits:2227,compJanVisits:876.2,fhJanRev:2.03,compJanRev:0.80,fhFebRev:2.46,compFebRev:0.85,fhJanConv:2.11,compJanConv:3.93,fhFebConv:3.17,compFebConv:2.49},
  {id:4445,name:"FabHotel SRH",city:"Pune",compRns:26.6,fhFebVisits:639,compFebVisits:336,fhJanVisits:2144,compJanVisits:1771.6,fhJanRev:2.35,compJanRev:0.91,fhFebRev:2.56,compFebRev:0.99,fhJanConv:4.34,compJanConv:4.81,fhFebConv:5.32,compFebConv:4.7},
  {id:4275,name:"FabHotel Keerthi's Anupama",city:"Vijayawada",compRns:65.8,fhFebVisits:581,compFebVisits:741.8,fhJanVisits:1595,compJanVisits:1394.5,fhJanRev:7.07,compJanRev:2.31,fhFebRev:3.71,compFebRev:2.22,fhJanConv:3.57,compJanConv:2.76,fhFebConv:6.2,compFebConv:6.39},
  {id:4265,name:"FabHotel Nanda - Nr. Ludhiana Junction",city:"Ludhiana",compRns:54,fhFebVisits:480,compFebVisits:740.33,fhJanVisits:3071,compJanVisits:4186,fhJanRev:2.63,compJanRev:0.82,fhFebRev:1.94,compFebRev:1.83,fhJanConv:3.97,compJanConv:1.06,fhFebConv:4.38,compFebConv:4.5},
  {id:4256,name:"FabHotel Grand Heritage - Nr. BKC",city:"Mumbai",compRns:52.6,fhFebVisits:1381,compFebVisits:2067.8,fhJanVisits:2570,compJanVisits:6569.6,fhJanRev:10.35,compJanRev:2.46,fhFebRev:10.02,compFebRev:3.09,fhJanConv:1.4,compJanConv:2.38,fhFebConv:4.2,compFebConv:1.51},
  {id:4192,name:"FabHotel Park Inn - Indiranagar",city:"Bangalore",compRns:138.4,fhFebVisits:1033,compFebVisits:3108,fhJanVisits:562,compJanVisits:1549.8,fhJanRev:9.11,compJanRev:6.80,fhFebRev:6.39,compFebRev:7.01,fhJanConv:2.31,compJanConv:2.06,fhFebConv:2.03,compFebConv:2.62},
  {id:3660,name:"FabHotel Frazer Suites",city:"Bangalore",compRns:24,fhFebVisits:197,compFebVisits:740.8,fhJanVisits:871,compJanVisits:484.83,fhJanRev:1.72,compJanRev:1.81,fhFebRev:2.28,compFebRev:1.33,fhJanConv:1.26,compJanConv:3.44,fhFebConv:6.6,compFebConv:1.94},
  {id:3606,name:"FabHotel Naman Palace",city:"Bhopal",compRns:9.67,fhFebVisits:198,compFebVisits:219.5,fhJanVisits:1273,compJanVisits:2651,fhJanRev:1.66,compJanRev:0.23,fhFebRev:0.33,compFebRev:0.24,fhJanConv:6.36,compJanConv:3.15,fhFebConv:1.52,compFebConv:3.72},
  {id:3355,name:"FabHotel B Zone",city:"Chennai",compRns:71.6,fhFebVisits:690,compFebVisits:1467.2,fhJanVisits:13,compJanVisits:135.67,fhJanRev:10.57,compJanRev:2.76,fhFebRev:12.5,compFebRev:3.68,fhJanConv:0,compJanConv:1.6,fhFebConv:6.38,compFebConv:3.52},
  {id:3245,name:"Via The Adore Palace",city:"Mumbai",compRns:106,fhFebVisits:115,compFebVisits:2826.17,fhJanVisits:1212,compJanVisits:834,fhJanRev:2.04,compJanRev:3.19,fhFebRev:3.5,compFebRev:7.04,fhJanConv:7.01,compJanConv:4.51,fhFebConv:0,compFebConv:2.17},
  {id:3142,name:"FabHotel Step Inn",city:"Kolkata",compRns:38,fhFebVisits:303,compFebVisits:320.2,fhJanVisits:723,compJanVisits:517,fhJanRev:4.35,compJanRev:1.01,fhFebRev:2.04,compFebRev:1.15,fhJanConv:4.29,compJanConv:4.87,fhFebConv:11.22,compFebConv:4.87},
  {id:2937,name:"FabHotel Rr Grand - Next To Trendset Mall",city:"Vijayawada",compRns:13,fhFebVisits:232,compFebVisits:193,fhJanVisits:303,compJanVisits:563.4,fhJanRev:5.06,compJanRev:0.81,fhFebRev:2.98,compFebRev:0.53,fhJanConv:0.33,compJanConv:0.21,fhFebConv:4.31,compFebConv:5.08},
  {id:2667,name:"Via Hemkunt Residency",city:"Noida",compRns:0.8,fhFebVisits:114,compFebVisits:375.6,fhJanVisits:5497,compJanVisits:2358.25,fhJanRev:0.12,compJanRev:0.00,fhFebRev:0.4,compFebRev:0.05,fhJanConv:1.38,compJanConv:2.26,fhFebConv:1.75,compFebConv:0.11}
];

function pct(a,b){return(b!=null&&b!==0&&a!=null)?((a/b)-1)*100:null}

function enrich(d){
  const fhRevChg=pct(d.fhFebRev,d.fhJanRev),compRevChg=pct(d.compFebRev,d.compJanRev);
  const fhVisChg=pct(d.fhFebVisits,d.fhJanVisits),compVisChg=pct(d.compFebVisits,d.compJanVisits);
  const fhConvChg=pct(d.fhFebConv,d.fhJanConv),compConvChg=pct(d.compFebConv,d.compJanConv);
  return{...d,fhRevChg,compRevChg,netRevChg:fhRevChg!=null&&compRevChg!=null?fhRevChg-compRevChg:null,
    fhVisChg,compVisChg,netVisChg:fhVisChg!=null&&compVisChg!=null?fhVisChg-compVisChg:null,
    fhConvChg,compConvChg,netConvChg:fhConvChg!=null&&compConvChg!=null?fhConvChg-compConvChg:null};
}

const DATA=RAW.map(enrich);

function makeCityRows(){
  const map={};
  DATA.forEach(d=>{
    if(!map[d.city])map[d.city]={city:d.city,count:0,fhFebRev:0,compFebRev:0,fhJanRev:0,compJanRev:0,fhFebVisits:0,compFebVisits:0,fhJanVisits:0,compJanVisits:0,fhJanConv:0,fhFebConv:0,compJanConv:0,compFebConv:0};
    const r=map[d.city];r.count++;
    r.fhFebRev+=d.fhFebRev||0;r.compFebRev+=d.compFebRev||0;r.fhJanRev+=d.fhJanRev||0;r.compJanRev+=d.compJanRev||0;
    r.fhFebVisits+=d.fhFebVisits||0;r.compFebVisits+=d.compFebVisits||0;r.fhJanVisits+=d.fhJanVisits||0;r.compJanVisits+=d.compJanVisits||0;
    r.fhJanConv+=d.fhJanConv||0;r.fhFebConv+=d.fhFebConv||0;r.compJanConv+=d.compJanConv||0;r.compFebConv+=d.compFebConv||0;
  });
  return Object.values(map).map(r=>{
    const n=r.count;r.fhJanConv/=n;r.fhFebConv/=n;r.compJanConv/=n;r.compFebConv/=n;
    const fhRevChg=pct(r.fhFebRev,r.fhJanRev),compRevChg=pct(r.compFebRev,r.compJanRev);
    const fhVisChg=pct(r.fhFebVisits,r.fhJanVisits),compVisChg=pct(r.compFebVisits,r.compJanVisits);
    const fhConvChg=pct(r.fhFebConv,r.fhJanConv),compConvChg=pct(r.compFebConv,r.compJanConv);
    return{...r,fhRevChg,compRevChg,netRevChg:fhRevChg!=null&&compRevChg!=null?fhRevChg-compRevChg:null,
      fhVisChg,compVisChg,netVisChg:fhVisChg!=null&&compVisChg!=null?fhVisChg-compVisChg:null,
      fhConvChg,compConvChg,netConvChg:fhConvChg!=null&&compConvChg!=null?fhConvChg-compConvChg:null};
  });
}

const CITY_ROWS=makeCityRows();
const CITIES=[...new Set(RAW.map(d=>d.city))].sort();

// Populate city select
const sel=document.getElementById('citySelect');
CITIES.forEach(c=>{const o=document.createElement('option');o.value=c;o.text=c;sel.appendChild(o);});

// State
let currentView='property';
let sortKey='id',sortDir='asc';
let colFilters={};
let openMenu=null;

// Column defs
const PROP_COLS=[
  {k:'id',label:'FH ID',cls:'col-id'},
  {k:'name',label:'Hotel',cls:'col-name'},
  {k:'city',label:'City'},
  {k:'fhJanRev',label:'FH Jan Rev (L)',grp:'grp-rev',cls:'col-rev',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'fhFebRev',label:'FH Feb Rev (L)',cls:'col-rev',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'compJanRev',label:'Comp Jan Rev (L)',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'compFebRev',label:'Comp Feb Rev (L)',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'fhRevChg',label:'FH Chg%',cls:'col-rev',badge:true},
  {k:'compRevChg',label:'Comp Chg%',badge:true},
  {k:'netRevChg',label:'Net Chg%',cls:'col-rev',badge:true},
  {k:'fhJanVisits',label:'FH Jan Visits',grp:'grp-vis',cls:'col-vis',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'fhFebVisits',label:'FH Feb Visits',cls:'col-vis',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'compJanVisits',label:'Comp Jan Visits',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'compFebVisits',label:'Comp Feb Visits',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'fhVisChg',label:'FH Chg%',cls:'col-vis',badge:true},
  {k:'compVisChg',label:'Comp Chg%',badge:true},
  {k:'netVisChg',label:'Net Chg%',cls:'col-vis',badge:true},
  {k:'fhJanConv',label:'FH Jan Conv%',grp:'grp-conv',cls:'col-conv',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'fhFebConv',label:'FH Feb Conv%',cls:'col-conv',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'compJanConv',label:'Comp Jan Conv%',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'compFebConv',label:'Comp Feb Conv%',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'fhConvChg',label:'FH Chg%',cls:'col-conv',badge:true},
  {k:'compConvChg',label:'Comp Chg%',badge:true},
  {k:'netConvChg',label:'Net Chg%',cls:'col-conv',badge:true}
];

const CITY_COLS=[
  {k:'city',label:'City',cls:'col-city-city'},
  {k:'count',label:'Props'},
  {k:'fhJanRev',label:'FH Jan Rev (L)',grp:'grp-rev',cls:'col-rev',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'fhFebRev',label:'FH Feb Rev (L)',cls:'col-rev',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'compJanRev',label:'Comp Jan Rev (L)',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'compFebRev',label:'Comp Feb Rev (L)',fmt:v=>v!=null?v.toFixed(2):'—'},
  {k:'fhRevChg',label:'FH Chg%',cls:'col-rev',badge:true},
  {k:'compRevChg',label:'Comp Chg%',badge:true},
  {k:'netRevChg',label:'Net Chg%',cls:'col-rev',badge:true},
  {k:'fhJanVisits',label:'FH Jan Visits',grp:'grp-vis',cls:'col-vis',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'fhFebVisits',label:'FH Feb Visits',cls:'col-vis',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'compJanVisits',label:'Comp Jan Visits',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'compFebVisits',label:'Comp Feb Visits',fmt:v=>v!=null?v.toLocaleString():'—'},
  {k:'fhVisChg',label:'FH Chg%',cls:'col-vis',badge:true},
  {k:'compVisChg',label:'Comp Chg%',badge:true},
  {k:'netVisChg',label:'Net Chg%',cls:'col-vis',badge:true},
  {k:'fhJanConv',label:'FH Jan Conv%',grp:'grp-conv',cls:'col-conv',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'fhFebConv',label:'FH Feb Conv%',cls:'col-conv',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'compJanConv',label:'Comp Jan Conv%',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'compFebConv',label:'Comp Feb Conv%',fmt:v=>v!=null?v.toFixed(2)+'%':'—'},
  {k:'fhConvChg',label:'FH Chg%',cls:'col-conv',badge:true},
  {k:'compConvChg',label:'Comp Chg%',badge:true},
  {k:'netConvChg',label:'Net Chg%',cls:'col-conv',badge:true}
];

function badge(v){
  if(v==null||isNaN(v))return'<span class="badge-na">—</span>';
  const pos=v>=0,cls=pos?'badge-up':'badge-dn',arr=pos?'▲':'▼';
  return`<span class="badge ${cls}">${arr} ${Math.abs(v).toFixed(1)}%</span>`;
}

function cellVal(col,d){
  const v=d[col.k];
  if(col.badge)return badge(v);
  if(col.fmt)return col.fmt(v);
  return v!=null?String(v):'—';
}

function sortableVal(col,d){
  const v=d[col.k];
  return v==null?-Infinity:typeof v==='number'?v:String(v).toLowerCase();
}

function getSource(){
  if(currentView==='city')return CITY_ROWS;
  const q=document.getElementById('searchBox').value.toLowerCase();
  const city=document.getElementById('citySelect').value;
  return DATA.filter(d=>{
    const m=!q||d.name.toLowerCase().includes(q)||d.city.toLowerCase().includes(q)||String(d.id).includes(q);
    return m&&(city==='All'||d.city===city);
  });
}

function getColValues(k,src){
  const set=new Set(src.map(d=>{const v=d[k];return v==null?'—':typeof v==='number'?String(parseFloat(v.toFixed(2))):String(v);}));
  return[...set].sort((a,b)=>{const na=parseFloat(a),nb=parseFloat(b);return isNaN(na)||isNaN(nb)?a.localeCompare(b):na-nb;});
}

function getFiltered(src){
  return src.filter(d=>{
    for(const[k,sel]of Object.entries(colFilters)){
      if(!sel||sel.size===0)continue;
      const v=d[k];const s=v==null?'—':typeof v==='number'?String(parseFloat(v.toFixed(2))):String(v);
      if(!sel.has(s))return false;
    }
    return true;
  });
}

function renderKPIs(){
  const src=currentView==='city'?DATA:(document.getElementById('citySelect').value==='All'?DATA:DATA.filter(d=>d.city===document.getElementById('citySelect').value));
  const fhRev=src.reduce((s,d)=>s+(d.fhFebRev||0),0),compRev=src.reduce((s,d)=>s+(d.compFebRev||0),0);
  const fhVis=src.reduce((s,d)=>s+(d.fhFebVisits||0),0),compVis=src.reduce((s,d)=>s+(d.compFebVisits||0),0);
  const fhConv=src.length?src.reduce((s,d)=>s+(d.fhFebConv||0),0)/src.length:0;
  const compConv=src.length?src.reduce((s,d)=>s+(d.compFebConv||0),0)/src.length:0;
  const kpis=[
    {label:'FH Feb Revenue',value:'₹'+fhRev.toFixed(2)+'L',p:compRev?((fhRev-compRev)/compRev)*100:null,color:'#34d399'},
    {label:'Total FH Visits',value:fhVis.toLocaleString(),p:compVis?((fhVis-compVis)/compVis)*100:null,color:'#a78bfa'},
    {label:'Avg. FH Conv.',value:fhConv.toFixed(2)+'%',p:compConv?((fhConv-compConv)/compConv)*100:null,color:'#fbbf24'}
  ];
  document.getElementById('kpiContainer').innerHTML=kpis.map(k=>`
    <div class="kpi" style="border:1px solid ${k.color}44">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value" style="color:${k.color}">${k.value}</div>
      <div class="kpi-foot">${badge(k.p)}<span class="kpi-vs">vs Comp</span></div>
    </div>`).join('');
}

function buildDropdown(col,src){
  if(col.badge)return'';// no value filter for badge cols
  const vals=getColValues(col.k,src);
  const sel=colFilters[col.k]||new Set();
  const items=vals.map(v=>`<label class="dd-item"><input type="checkbox" onchange="toggleFilter('${col.k}','${v.replace(/'/g,"\\'")}',this)" ${sel.has(v)?'checked':''}/><span>${v}</span></label>`).join('');
  return`
    <div class="dd-divider">
      <div class="dd-search"><input type="text" placeholder="Search values..." oninput="filterDropdown(this,'${col.k}',${JSON.stringify(vals)})" onclick="event.stopPropagation()"/></div>
      <div class="dd-actions"><span class="sel-all" onclick="selectAll('${col.k}')">Select All</span><span class="dd-sep">|</span><span class="clr" onclick="clearFilter('${col.k}')">Clear</span></div>
      <div class="dd-list" id="ddlist-${col.k}">${items||'<div class="dd-empty">No values</div>'}</div>
    </div>`;
}

function renderTable(){
  const cols=currentView==='city'?CITY_COLS:PROP_COLS;
  const src=getSource();
  const filtered=getFiltered(src);
  const sorted=[...filtered].sort((a,b)=>{
    const av=sortableVal({k:sortKey},a),bv=sortableVal({k:sortKey},b);
    return sortDir==='asc'?(av>bv?1:-1):(av<bv?1:-1);
  });

  // Head
  const thHTML=cols.map(col=>{
    const hasFilter=colFilters[col.k]&&colFilters[col.k].size>0;
    const arrowCls=hasFilter?'th-arrow filtered':'th-arrow';
    const arrowTxt=hasFilter?'▼●':'▼';
    const grpCls=col.grp?col.grp:'';
    const colCls=col.cls||'';
    const sortRows=`
      <div class="dd-sort-row ${sortKey===col.k&&sortDir==='asc'?'active':''}" onclick="doSort('${col.k}','asc')">↑ Sort A to Z</div>
      <div class="dd-sort-row ${sortKey===col.k&&sortDir==='desc'?'active':''}" onclick="doSort('${col.k}','desc')">↓ Sort Z to A</div>
      <div class="dd-divider"></div>`;
    const dd=buildDropdown(col,src);
    return`<th class="${grpCls}">
      <div class="th-inner">
        <span class="${colCls}">${col.label}</span>
        <span class="${arrowCls}" onclick="event.stopPropagation();toggleMenu('${col.k}')">${arrowTxt}</span>
      </div>
      <div class="dropdown" id="dd-${col.k}">
        ${sortRows}${dd}
      </div>
    </th>`;
  }).join('');
  document.getElementById('thead').innerHTML=`<tr>${thHTML}</tr>`;

  // Body
  if(sorted.length===0){
    document.getElementById('tbody').innerHTML=`<tr><td colspan="${cols.length}" style="padding:40px;text-align:center;color:#334155">No data matches your filters.</td></tr>`;
  } else {
    document.getElementById('tbody').innerHTML=sorted.map((d,i)=>{
      const bg=i%2!==0?'background:#0d1020':'';
      const cells=cols.map(col=>{
        const grpCls=col.grp?col.grp:'';
        const val=cellVal(col,d);
        const extraStyle=col.cls&&!col.badge?`color:${getColColor(col.cls)};font-weight:600`:'';
        return`<td class="${grpCls}" style="${extraStyle}">${val}</td>`;
      }).join('');
      return`<tr style="${bg}">${cells}</tr>`;
    }).join('');
  }

  // Footer
  const active=Object.values(colFilters).filter(s=>s&&s.size>0).length;
  document.getElementById('footLeft').textContent=currentView==='city'?`${sorted.length} cities`:`Showing ${sorted.length} of ${RAW.length} properties`;
  document.getElementById('footRight').textContent=active?`${active} column filter${active>1?'s':''} active`:'';
  document.getElementById('btnClear').style.display=active?'inline-block':'none';

  renderKPIs();
  if(openMenu)openDropdown(openMenu);
}

function getColColor(cls){
  const map={'col-rev':'#34d399','col-vis':'#a78bfa','col-conv':'#fbbf24','col-id':'#60a5fa','col-name':'#e2e8f0','col-city-city':'#38bdf8'};
  return map[cls]||'inherit';
}

function toggleMenu(k){
  if(openMenu===k){openMenu=null;closeAll();return;}
  closeAll();openMenu=k;openDropdown(k);
}

function openDropdown(k){
  const el=document.getElementById('dd-'+k);
  if(el)el.classList.add('open');
}

function closeAll(){
  document.querySelectorAll('.dropdown').forEach(el=>el.classList.remove('open'));
  openMenu=null;
}

document.addEventListener('click',()=>{closeAll();});

function doSort(k,dir){sortKey=k;sortDir=dir;closeAll();openMenu=null;renderTable();}

function toggleFilter(k,v,cb){
  if(!colFilters[k])colFilters[k]=new Set();
  cb.checked?colFilters[k].add(v):colFilters[k].delete(v);
  renderTable();openMenu=k;
}

function selectAll(k){
  const src=getSource();
  colFilters[k]=new Set(getColValues(k,src));
  renderTable();openMenu=k;
}

function clearFilter(k){
  colFilters[k]=new Set();
  renderTable();openMenu=k;
}

function clearAllFilters(){colFilters={};renderTable();}

function filterDropdown(inp,k,allVals){
  const q=inp.value.toLowerCase();
  const sel=colFilters[k]||new Set();
  const vis=q?allVals.filter(v=>v.toLowerCase().includes(q)):allVals;
  const list=document.getElementById('ddlist-'+k);
  if(!list)return;
  list.innerHTML=vis.length?vis.map(v=>`<label class="dd-item"><input type="checkbox" onchange="toggleFilter('${k}','${v.replace(/'/g,"\\'")}',this)" ${sel.has(v)?'checked':''}/><span>${v}</span></label>`).join(''):`<div class="dd-empty">No values</div>`;
  event.stopPropagation();
}

function setView(v){
  currentView=v;colFilters={};sortKey=v==='city'?'city':'id';sortDir='asc';
  document.getElementById('toolbar').style.display=v==='city'?'none':'flex';
  document.getElementById('btnProp').style.borderColor=v==='property'?'#94a3b8':'#1a2035';
  document.getElementById('btnProp').style.color=v==='property'?'#94a3b8':'#64748b';
  document.getElementById('btnProp').style.background=v==='property'?'#94a3b822':'#0b0e18';
  document.getElementById('btnCity').style.borderColor=v==='city'?'#38bdf8':'#1a2035';
  document.getElementById('btnCity').style.color=v==='city'?'#38bdf8':'#64748b';
  document.getElementById('btnCity').style.background=v==='city'?'#38bdf822':'#0b0e18';
  renderTable();
}

// Init
setView('property');
</script>
</body>
</html>
